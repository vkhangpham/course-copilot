#!/bin/sh
#
# commit-msg hook for ccopilot
#
# Validates commit message format:
# - Conventional commits format (type(scope): subject)
# - Optional bd issue references
#

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Skip validation for merge commits
if grep -qE "^Merge (branch|remote-tracking branch)" "$COMMIT_MSG_FILE"; then
    exit 0
fi

# Skip validation for revert commits
if grep -qE "^Revert \"" "$COMMIT_MSG_FILE"; then
    exit 0
fi

# Conventional commit types
VALID_TYPES="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"

# Pattern: type(optional-scope): subject
# Examples:
#   feat: add new feature
#   fix(auth): resolve login issue
#   chore: update dependencies
#   feat(bd-123): implement new endpoint
PATTERN="^($VALID_TYPES)(\(.+\))?: .+"

# Extract first line (subject)
SUBJECT=$(echo "$COMMIT_MSG" | head -n1)

# Check if subject matches conventional commit format
if ! echo "$SUBJECT" | grep -qE "$PATTERN"; then
    echo "${RED}[commit-msg]${NC} Invalid commit message format" >&2
    echo "" >&2
    echo "Commit message must follow conventional commits format:" >&2
    echo "  <type>(optional-scope): <subject>" >&2
    echo "" >&2
    echo "Valid types: $VALID_TYPES" >&2
    echo "" >&2
    echo "Examples:" >&2
    echo "  feat: add user authentication" >&2
    echo "  fix(api): resolve timeout issue" >&2
    echo "  chore(bd-123): update dependencies" >&2
    echo "  docs: improve README" >&2
    echo "" >&2
    echo "Your commit message:" >&2
    echo "  $SUBJECT" >&2
    exit 1
fi

# Check subject length (recommended: 50 characters or less)
SUBJECT_LENGTH=$(echo "$SUBJECT" | wc -c | tr -d ' ')
if [ "$SUBJECT_LENGTH" -gt 72 ]; then
    echo "${YELLOW}[commit-msg]${NC} Warning: Subject line is longer than 72 characters ($SUBJECT_LENGTH)" >&2
    echo "Consider keeping it under 50 characters for better readability" >&2
    # Don't fail, just warn
fi

# Optional: Check for bd issue reference in commits
# Uncomment to enforce bd issue references in commits
# if ! echo "$COMMIT_MSG" | grep -qE "bd-[0-9]+"; then
#     echo "${YELLOW}[commit-msg]${NC} Warning: No bd issue reference found" >&2
#     echo "Consider adding 'bd-XXX' to link this commit to an issue" >&2
# fi

exit 0
