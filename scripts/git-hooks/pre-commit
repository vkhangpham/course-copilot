#!/bin/sh
#
# Enhanced pre-commit hook for ccopilot
#
# This hook runs:
# 1. bd (beads) sync to flush issue changes
# 2. ruff format and check on staged Python files
# 3. Optional: prettier for other file types
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${GREEN}[pre-commit]${NC} Running pre-commit checks..."

# ============================================================================
# 1. BD (BEADS) SYNC
# ============================================================================
if command -v bd >/dev/null 2>&1 && [ -d .beads ]; then
    echo "${GREEN}[pre-commit]${NC} Syncing bd issues..."
    if ! bd sync --flush-only >/dev/null 2>&1; then
        echo "${RED}[pre-commit]${NC} Failed to flush bd changes to JSONL" >&2
        echo "Run 'bd sync --flush-only' manually to diagnose" >&2
        exit 1
    fi

    # Stage the JSONL file if it was modified
    if [ -f .beads/issues.jsonl ]; then
        git add .beads/issues.jsonl 2>/dev/null || true
    fi
fi

# ============================================================================
# 2. PYTHON FORMATTING AND LINTING (RUFF)
# ============================================================================
if command -v ruff >/dev/null 2>&1; then
    # Get staged Python files
    STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

    if [ -n "$STAGED_PY_FILES" ]; then
        echo "${GREEN}[pre-commit]${NC} Running ruff format on staged Python files..."

        # Format the files
        if ! echo "$STAGED_PY_FILES" | xargs ruff format 2>&1; then
            echo "${RED}[pre-commit]${NC} ruff format failed" >&2
            exit 1
        fi

        # Run ruff check with auto-fix
        echo "${GREEN}[pre-commit]${NC} Running ruff check --fix on staged Python files..."
        if ! echo "$STAGED_PY_FILES" | xargs ruff check --fix 2>&1; then
            echo "${YELLOW}[pre-commit]${NC} ruff check found issues that couldn't be auto-fixed" >&2
            echo "Please review and fix manually, then stage the changes" >&2
            exit 1
        fi

        # Re-stage the formatted files
        echo "$STAGED_PY_FILES" | xargs git add
        echo "${GREEN}[pre-commit]${NC} Python files formatted and linted successfully"
    fi
else
    echo "${YELLOW}[pre-commit]${NC} ruff not found, skipping Python formatting"
fi

# ============================================================================
# 3. MARKDOWN/YAML/JSON FORMATTING (PRETTIER - OPTIONAL)
# ============================================================================
if command -v prettier >/dev/null 2>&1; then
    # Get staged markdown, yaml, json files
    STAGED_FORMAT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|yaml|yml|json)$' || true)

    if [ -n "$STAGED_FORMAT_FILES" ]; then
        echo "${GREEN}[pre-commit]${NC} Running prettier on staged files..."

        if ! echo "$STAGED_FORMAT_FILES" | xargs prettier --write 2>&1; then
            echo "${RED}[pre-commit]${NC} prettier failed" >&2
            exit 1
        fi

        # Re-stage the formatted files
        echo "$STAGED_FORMAT_FILES" | xargs git add
        echo "${GREEN}[pre-commit]${NC} Markdown/YAML/JSON files formatted successfully"
    fi
fi

# ============================================================================
# 4. OPTIONAL: AST-GREP CHECKS
# ============================================================================
# Uncomment to enable ast-grep checks
# if command -v ast-grep >/dev/null 2>&1; then
#     echo "${GREEN}[pre-commit]${NC} Running ast-grep checks..."
#
#     # Example: Check for console.log in TypeScript/JavaScript
#     if ast-grep --pattern 'console.log($$$)' frontend/ 2>/dev/null | grep -q .; then
#         echo "${YELLOW}[pre-commit]${NC} Warning: console.log statements found"
#     fi
# fi

echo "${GREEN}[pre-commit]${NC} All checks passed!"
exit 0
